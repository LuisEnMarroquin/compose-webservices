image: docker/compose:1.25.0-rc2

stages:
  - deploy

variables:
  PRO_NAME: code
  FULL_URL: code.marroquin.dev

.variables: &deploy_variables
  stage: deploy
  only:
    - master
  tags:
    - production
deploy:
  <<: *deploy_variables
  script:
    - docker-compose --project-name ${PRO_NAME} up -d --build --force-recreate --remove-orphans
  environment:
    name: master
    url: https://${FULL_URL}
    on_stop: stop
stop:
  <<: *deploy_variables
  when: manual
  script:
    - docker-compose --project-name ${PRO_NAME} stop
  environment:
    name: master
    action: stop
